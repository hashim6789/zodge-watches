<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Coupon Management</title>
    <!-- plugins:css -->
    <link
      rel="stylesheet"
      href="/public/assets/vendors/mdi/css/materialdesignicons.min.css"
    />
    <link
      rel="stylesheet"
      href="/public/assets/vendors/css/vendor.bundle.base.css"
    />
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="/public/assets/css/style.css" />
    <!-- End layout styles -->
    <link rel="shortcut icon" href="/public/assets/images/favicon.png" />
    <!-- Load jQuery from a CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div class="container-scroller">
      <!-- partial:partials/_sidebar.ejs -->
      <%- include('partials/_sidebar') %>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_navbar.ejs -->
        <%- include('partials/_navbar', { pageType: 'coupons' }) %>
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
            <a href="/admin/dashboard">Admin</a>
            > <a href="/admin/coupons">Coupon Management</a>
            <div class="row">
              <div class="col-12 grid-margin">
                <div class="card">
                  <div class="card-body">
                    <div
                      class="d-flex justify-content-between align-items-center mb-4"
                    >
                      <h4 class="card-title">Coupon Management</h4>
                      <button
                        class="btn btn-success"
                        data-toggle="modal"
                        data-target="#createCouponModal"
                      >
                        Create New Coupon
                      </button>
                    </div>
                    <div class="table-responsive">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>SI</th>
                            <th>Code</th>
                            <th>Discount</th>
                            <th>Description</th>
                            <th>Expiry Date</th>
                            <th>Purchase Range</th>
                            <th>Usage Limit</th>
                            <th>Action</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% coupons.forEach((coupon, idx) => { %>
                          <tr>
                            <td>
                              <%= ((current - 1) * perPage) + (idx + 1) %>
                            </td>

                            <td><%= coupon.code %></td>
                            <td><%= coupon.discountValue %>%</td>
                            <td><%= coupon.description %></td>
                            <td>
                              <%= coupon.expiryDate.toLocaleDateString() %>
                            </td>
                            <td>
                              <%= coupon.minPurchaseAmount %> - <%=
                              coupon.maxPurchaseAmount %>
                            </td>
                            <td><%= coupon.usageLimit %></td>
                            <td>
                              <button
                                class="btn btn-primary"
                                data-toggle="modal"
                                data-target="#editCouponModal"
                                data-id="<%= coupon._id %>"
                                data-name="<%= coupon.name %>"
                                onclick="populateEditCouponModal('<%= coupon._id %>', '<%= coupon.name %>')"
                              >
                                Edit
                              </button>
                              <button
                                id="listButton-<%= coupon._id %>"
                                class="btn <%= coupon.isListed ? 'btn-danger' : 'btn-success' %>"
                                onclick="confirmAndToggleListCoupon('<%= coupon._id %>', '<%= coupon.isListed %>')"
                              >
                                <%= coupon.isListed ? 'Unlist' : 'List' %>
                              </button>
                            </td>
                          </tr>
                          <% }) %>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Pagination -->
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-center">
                <% if (current > 1) { %>
                <li class="page-item">
                  <a
                    class="page-link"
                    href="?page=<%= current - 1 %>"
                    aria-label="Previous"
                  >
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <% } %> <% for (let i = 1; i <= pages; i++) { %>
                <li class="page-item <%= current == i ? 'active' : '' %>">
                  <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                </li>
                <% } %> <% if (current < pages) { %>
                <li class="page-item">
                  <a
                    class="page-link"
                    href="?page=<%= ++current %>"
                    aria-label="Next"
                  >
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
                <% } %>
              </ul>
            </nav>
          </div>

          <!-- Create Coupon Modal -->
          <div
            class="modal fade"
            id="createCouponModal"
            tabindex="-1"
            aria-labelledby="createCouponModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <form id="createCouponForm">
                  <div class="modal-header">
                    <h5 class="modal-title" id="createCouponModalLabel">
                      Create New Coupon
                    </h5>
                    <button
                      type="button"
                      class="close"
                      data-dismiss="modal"
                      aria-label="Close"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="form-group">
                      <label for="couponCode">Coupon Code</label>
                      <input
                        type="text"
                        id="couponCode"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="description">Description</label>
                      <textarea
                        id="description"
                        class="form-control"
                        required
                      ></textarea>
                    </div>
                    <div class="form-group">
                      <label for="discountValue">Discount Value (%)</label>
                      <input
                        type="number"
                        id="discountValue"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="expiryDate">Expiry Date</label>
                      <input
                        type="date"
                        id="expiryDate"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="minimumPurchase">Minimum Purchase</label>
                      <input
                        type="number"
                        id="minimumPurchase"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="maximumPurchase">Maximum Purchase</label>
                      <input
                        type="number"
                        id="maximumPurchase"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="usageLimit">Usage Limit</label>
                      <input
                        type="number"
                        id="usageLimit"
                        class="form-control"
                        required
                      />
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-dismiss="modal"
                    >
                      Close
                    </button>
                    <button type="submit" class="btn btn-primary">
                      Create Coupon
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Edit Coupon Modal -->
          <div
            class="modal fade"
            id="editCouponModal"
            tabindex="-1"
            aria-labelledby="editCouponModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog">
              <div class="modal-content">
                <form id="editCouponForm">
                  <div class="modal-header">
                    <h5 class="modal-title" id="editCouponModalLabel">
                      Edit Coupon
                    </h5>
                    <button
                      type="button"
                      class="close"
                      data-dismiss="modal"
                      aria-label="Close"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <input type="hidden" id="editCouponId" name="couponId" />

                    <div class="form-group">
                      <label for="editCouponCode">Coupon Code</label>
                      <input
                        type="text"
                        id="editCouponCode"
                        class="form-control"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="editCouponDiscount">Discount Value (%)</label>
                      <input
                        type="number"
                        id="editCouponDiscount"
                        class="form-control"
                        required
                      />
                    </div>
                    <div class="form-group">
                      <label for="editCouponExpiry">Expiry Date</label>
                      <input
                        type="date"
                        id="editCouponExpiry"
                        class="form-control"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="editCouponDescription">Description</label>
                      <textarea
                        id="editCouponDescription"
                        class="form-control"
                        required
                      ></textarea>
                    </div>

                    <div class="form-group">
                      <label for="editCouponMaxPurchase"
                        >Maximum Purchase</label
                      >
                      <input
                        type="number"
                        id="editCouponMaxPurchase"
                        class="form-control"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="editCouponMinPurchase"
                        >Minimum Purchase</label
                      >
                      <input
                        type="number"
                        id="editCouponMinPurchase"
                        class="form-control"
                        required
                      />
                    </div>

                    <div class="form-group">
                      <label for="editCouponUsageLimit">Usage Limit</label>
                      <input
                        type="number"
                        id="editCouponUsageLimit"
                        class="form-control"
                        required
                      />
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-dismiss="modal"
                    >
                      Close
                    </button>
                    <button type="submit" class="btn btn-primary">
                      Save changes
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- End Modals -->
          <!-- partial:partials/_footer.ejs -->
          <%- include('partials/_footer') %>
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->

    <!-- plugins:js -->
    <script src="/public/assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="/public/assets/js/off-canvas.js"></script>
    <script src="/public/assets/js/hoverable-collapse.js"></script>
    <script src="/public/assets/js/misc.js"></script>
    <script src="/public/assets/js/settings.js"></script>
    <script src="/public/assets/js/todolist.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="/public/assets/js/dashboard.js"></script>
    <!-- End custom js for this page -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      // Coupon creation form submission
      document
        .getElementById("createCouponForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Accessing form values
          const couponCode = document.getElementById("couponCode").value;
          const expiryDate = document.getElementById("expiryDate").value;
          const description = document.getElementById("description").value;
          const discountValue = document.getElementById("discountValue").value;
          const maximumPurchase =
            document.getElementById("maximumPurchase").value;
          const minimumPurchase =
            document.getElementById("minimumPurchase").value;
          const usageLimit = document.getElementById("usageLimit").value;

          console.log(
            couponCode,
            expiryDate,
            description,
            discountValue,
            maximumPurchase,
            minimumPurchase,
            usageLimit
          );

          // Axios POST request
          axios
            .post("/admin/coupons", {
              code: couponCode.toUpperCase(),
              expiryDate,
              description,
              discountValue,
              maximumPurchase,
              minimumPurchase,
              usageLimit,
            })
            .then((response) => {
              if (response.data.success) {
                Swal.fire(
                  "Coupon Created",
                  "The coupon has been created successfully.",
                  "success"
                ).then(() => {
                  // Close modal and reset form
                  $("#createCouponModal").modal("hide");
                  document.getElementById("createCouponForm").reset();
                  window.location.reload(); // Reload the page to see the edit coupon
                });
              } else {
                Swal.fire(
                  "Error",
                  "There was a problem creating the coupon.",
                  "error"
                );
              }
            })
            .catch((error) => {
              Swal.fire("Error", "A server error occurred.", "error");
            });
        });
    </script>

    <script>
      function confirmAndToggleListCoupon(id, isListed) {
        const action = isListed === "true" ? "Unlist" : "List";

        Swal.fire({
          title: `Are you sure you want to ${action} this coupon?`,
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: `Yes, ${action} it!`,
        }).then((result) => {
          if (result.isConfirmed) {
            axios
              .put(`/admin/coupons/${id}/unlist`, {
                isListed: isListed === "true" ? false : true,
              })
              .then((response) => {
                const data = response.data.coupon; // Assuming response contains the updated coupon

                // Select the button element using the coupon id
                const buttonElement = document.getElementById(
                  `listButton-${data._id}`
                );

                // Toggle the button text between 'List' and 'Unlist'
                const result = data.isListed ? "Unlist" : "List";

                // Toggle the button class between 'btn-success' and 'btn-danger'
                const buttonClass = data.isListed
                  ? "btn-danger"
                  : "btn-success";

                // Update button properties
                buttonElement.className = `btn ${buttonClass}`;
                buttonElement.innerHTML = result;
                buttonElement.setAttribute(
                  "onclick",
                  `confirmAndToggleListCoupon("${data._id}", "${data.isListed}")`
                );

                Swal.fire(
                  `${action}ed!`,
                  `Coupon has been ${action.toLowerCase()}ed.`,
                  "success"
                );
              })
              .catch((error) => {
                Swal.fire(
                  "Error",
                  "There was a problem updating the coupon status.",
                  "error"
                );
              });
          }
        });
      }
    </script>

    <script>
      // Function to populate edit coupon modal with existing data
      // Function to populate edit coupon modal with existing data
      function populateEditCouponModal(couponId) {
        // Get the table row element that corresponds to this coupon
        const row = document
          .querySelector(`button[data-id='${couponId}']`)
          .closest("tr");

        // Extract the coupon data from the table cells
        const couponCode = row.children[1].innerText; // Code
        const couponDiscount = row.children[2].innerText.replace("%", ""); // Discount
        const couponDescription = row.children[3].innerText; // Description
        const couponExpiryDate = row.children[4].innerText; // Expiry Date
        const purchaseRange = row.children[5].innerText.split("-"); // Purchase Range (Min and Max)
        const couponMinPurchase = purchaseRange[0].trim(); // Minimum Purchase
        const couponMaxPurchase = purchaseRange[1].trim(); // Maximum Purchase
        const couponUsageLimit = row.children[6].innerText; // Usage Limit

        // Populate the modal form fields with the extracted data
        document.getElementById("editCouponId").value = couponId;
        document.getElementById("editCouponCode").value = couponCode;
        document.getElementById("editCouponDiscount").value = couponDiscount;
        document.getElementById("editCouponDescription").value =
          couponDescription;
        document.getElementById("editCouponExpiry").value =
          formatDateForInput(couponExpiryDate); // Format the date for input[type="date"]
        document.getElementById("editCouponMinPurchase").value =
          couponMinPurchase;
        document.getElementById("editCouponMaxPurchase").value =
          couponMaxPurchase;
        document.getElementById("editCouponUsageLimit").value =
          couponUsageLimit;
      }

      // Helper function to format the date into yyyy-mm-dd for input[type="date"]
      function formatDateForInput(dateString) {
        const parts = dateString.split("/");
        return `${parts[2]}-${parts[1].padStart(2, "0")}-${parts[0].padStart(
          2,
          "0"
        )}`;
      }

      // Function to handle the form submission for editing the coupon
      document
        .getElementById("editCouponForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Get the updated coupon data from the form
          const couponId = document.getElementById("editCouponId").value;
          const updatedCouponCode =
            document.getElementById("editCouponCode").value;
          const updatedCouponExpiry =
            document.getElementById("editCouponExpiry").value;
          const updatedCouponDescription = document.getElementById(
            "editCouponDescription"
          ).value;
          const updatedCouponDiscount =
            document.getElementById("editCouponDiscount").value;
          const updatedCouponMaxPurchase = document.getElementById(
            "editCouponMaxPurchase"
          ).value;
          const updatedCouponMinPurchase = document.getElementById(
            "editCouponMinPurchase"
          ).value;
          const updatedCouponUsageLimit = document.getElementById(
            "editCouponUsageLimit"
          ).value;

          console.log("code = ", updatedCouponCode);

          // Axios PUT request to update the coupon
          axios
            .put("/admin/coupons/" + couponId, {
              code: updatedCouponCode.toUpperCase(),
              expiryDate: updatedCouponExpiry,
              description: updatedCouponDescription,
              discountValue: updatedCouponDiscount,
              maximumPurchase: updatedCouponMaxPurchase,
              minimumPurchase: updatedCouponMinPurchase,
              usageLimit: updatedCouponUsageLimit,
            })
            .then((response) => {
              if (response.data.updatedCoupon) {
                Swal.fire(
                  "Coupon Updated",
                  "The coupon has been updated successfully.",
                  "success"
                ).then(() => {
                  // Close the modal and refresh the page to show updated data
                  $("#editCouponModal").modal("hide");
                  window.location.reload();
                });
              } else {
                Swal.fire(
                  "Error",
                  "There was a problem updating the coupon.",
                  "error"
                );
              }
            })
            .catch((error) => {
              Swal.fire("Error", "A server error occurred.", "error");
            });
        });

      // Delete coupon function
      function deleteCoupon(id) {
        if (confirm("Are you sure you want to delete this coupon?")) {
          // Add your delete functionality here
          console.log("Coupon deleted: ", id);
        }
      }
    </script>
  </body>
</html>
